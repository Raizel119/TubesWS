<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookara</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https.googleapis.com">
    <link rel="preconnect" href="https.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=search" />
    <link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    <header class="navbar">
        <div class="container">
            <div class="navbar-left">
                <a href="/" class="navbar-brand">
                    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Bookara Logo">
                </a>
                <div class="dropdown">
                    <a href="/" class="nav-link">Kategori <span class="arrow"></span></a>
                    <div class="dropdown-content">
                        {% for cat in all_categories %}
                            <a href="/?filter=cat_{{ cat | uquote }}">{{ cat }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <nav class="navbar-right">
                <a href="/" class="nav-link active">Home</a>
                <a href="#" class="nav-link">About Us</a>
                <a href="#" class="nav-link">Contact</a>
            </nav>
        </div>
    </header>

    <main>
        {% if not (current_filter or search_query or current_lang != 'all' or selected_sort_price) %}
        <section class="hero-carousel">
            <div class="carousel-slider">
                <div class="slide" id="slide-1"> 
                    <div class="slide-content">
                        <h1>Explore Great Books</h1>
                        <p>Temukan dunia baru di setiap halaman.</p>
                    </div>
                </div>
                <div class="slide" id="slide-2">
                    <div class="slide-content">
                        <h1>Find Your Book Match</h1>
                        <p>Pilih bacaan yang paling sesuai dengan minat dan gaya Anda.</p>
                    </div>
                </div>
                <div class="slide" id="slide-3">
                    <div class="slide-content">
                        <h1>Browse by Category</h1>
                        <p>Pilih kategori favorit Anda untuk menemukan bacaan yang tepat.</p>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <div class="container page-layout">
            
            <aside class="filter-sidebar">
                <form action="/" method="GET" class="filter-form-v3">
                    <input type="hidden" name="query" value="{{ search_query or '' }}">
                    <input type="hidden" name="sort_price" value="{{ selected_sort_price or '' }}">

                    <h2 class="filter-title">Filter</h2>

                    <!-- 1. FILTER KATEGORI -->
                    <details class="filter-group" open>
                        <summary class="filter-group-title">Kategori</summary>
                        <div class="filter-options-list">
                            
                            <a href="/?query={{ search_query or '' }}&lang={{ current_lang or 'all' }}&sort_price={{ selected_sort_price or '' }}"
                               class="filter-item-link {% if not current_filter %}active{% endif %}">
                                <span>Semua Kategori</span>
                            </a>

                            <!-- LEVEL 1: Kategori Utama -->
                            {% for category, sub_map in nested_category_map.items() %}
                                
                                <!-- Logic Open Parent -->
                                <details class="filter-item-nested" 
                                    {% if current_filter == 'cat_' + category %}open
                                    {% elif current_filter and current_filter.startswith('sub_') and current_filter.replace('sub_', '') in sub_map %}open
                                    {% elif current_filter and (current_filter.startswith('subsub_') or current_filter.startswith('sub3_')) %}
                                        {# Cek recursive apakah anak/cucu ada di kategori ini #}
                                        {% set is_child = False %}
                                        {% for s1, s2_map in sub_map.items() %}
                                            {% if current_filter == 'subsub_' + s1 or current_filter.replace('subsub_', '') in s2_map %}
                                                {% set is_child = True %}
                                            {% elif current_filter.startswith('sub3_') %}
                                                {% for s3_list in s2_map.values() %}
                                                    {% if current_filter.replace('sub3_', '') in s3_list %}{% set is_child = True %}{% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if is_child %}open{% endif %}
                                    {% endif %}>
                                
                                    <summary>
                                        <a href="/?filter=cat_{{ category | uquote }}&query={{ search_query or '' }}&lang={{ current_lang or 'all' }}&sort_price={{ selected_sort_price or '' }}"
                                           class="filter-item-label {% if current_filter == 'cat_' + category %}active{% endif %}">
                                            <span>{{ category }}</span>
                                        </a>
                                    </summary>

                                    <div class="filter-options-nested">
                                        <!-- LEVEL 2: Subkategori 1 -->
                                        {% for sub_category, sub2_map in sub_map.items() %}
                                            
                                            <details class="filter-item-nested"
                                                {% if current_filter == 'sub_' + sub_category %}open
                                                {% elif current_filter and current_filter.startswith('subsub_') and current_filter.replace('subsub_', '') in sub2_map %}open
                                                {% elif current_filter and current_filter.startswith('sub3_') %}
                                                    {# Cek Sub3 #}
                                                    {% set target3 = current_filter.replace('sub3_', '') %}
                                                    {% set is_gchild = False %}
                                                    {% for s3_list in sub2_map.values() %}
                                                        {% if target3 in s3_list %}{% set is_gchild = True %}{% endif %}
                                                    {% endfor %}
                                                    {% if is_gchild %}open{% endif %}
                                                {% endif %}>
                                                
                                                <summary>
                                                    <a href="/?filter=sub_{{ sub_category | uquote }}&query={{ search_query or '' }}&lang={{ current_lang or 'all' }}&sort_price={{ selected_sort_price or '' }}"
                                                       class="filter-item-label {% if current_filter == 'sub_' + sub_category %}active{% endif %}">
                                                        <span>{{ sub_category }}</span>
                                                    </a>
                                                </summary>
                                                
                                                <div class="filter-options-nested-sub">
                                                    <!-- LEVEL 3: Subkategori 2 -->
                                                    {% for sub2, sub3_list in sub2_map.items() %}
                                                        
                                                        <!-- Jika punya Sub3, buat details lagi. Jika tidak, link biasa -->
                                                        {% if sub3_list %}
                                                            <details class="filter-item-nested" style="margin-left: 10px;"
                                                                {% if current_filter == 'subsub_' + sub2 %}open
                                                                {% elif current_filter.replace('sub3_', '') in sub3_list %}open
                                                                {% endif %}>
                                                                
                                                                <summary>
                                                                    <a href="/?filter=subsub_{{ sub2 | uquote }}&query={{ search_query or '' }}&lang={{ current_lang or 'all' }}&sort_price={{ selected_sort_price or '' }}"
                                                                    class="filter-item-label {% if current_filter == 'subsub_' + sub2 %}active{% endif %}">
                                                                        <span>{{ sub2 }}</span>
                                                                    </a>
                                                                </summary>

                                                                <!-- LEVEL 4: Subkategori 3 -->
                                                                <div class="filter-options-nested-sub" style="padding-left: 15px;">
                                                                    {% for sub3 in sub3_list %}
                                                                        <a href="/?filter=sub3_{{ sub3 | uquote }}&query={{ search_query or '' }}&lang={{ current_lang or 'all' }}&sort_price={{ selected_sort_price or '' }}"
                                                                        class="filter-item-label {% if current_filter == 'sub3_' + sub3 %}active{% endif %}">
                                                                            <span>{{ sub3 }}</span>
                                                                        </a>
                                                                    {% endfor %}
                                                                </div>
                                                            </details>
                                                        {% else %}
                                                            <!-- Tidak punya Sub3, render sebagai link biasa -->
                                                            <a href="/?filter=subsub_{{ sub2 | uquote }}&query={{ search_query or '' }}&lang={{ current_lang or 'all' }}&sort_price={{ selected_sort_price or '' }}"
                                                               class="filter-item-label {% if current_filter == 'subsub_' + sub2 %}active{% endif %}">
                                                                <span>{{ sub2 }}</span>
                                                            </a>
                                                        {% endif %}

                                                    {% endfor %}
                                                </div>
                                            </details>
                                        {% endfor %}
                                    </div>
                                </details>
                            {% endfor %}
                        </div>
                    </details>
                    
                    <!-- 2. FILTER BAHASA -->
                    <details class="filter-group" open>
                        <summary class="filter-group-title">Bahasa</summary>
                        <div class="filter-options-list">
                            <label class="filter-item">
                                <input type="radio" name="lang" value="all" 
                                       {% if current_lang == 'all' %}checked{% endif %} 
                                       onchange="this.form.submit()">
                                <span>Semua Bahasa</span>
                            </label>
                            {% for lang in all_languages %}
                            <label class="filter-item">
                                <input type="radio" name="lang" value="{{ lang }}" 
                                       {% if current_lang == lang %}checked{% endif %} 
                                       onchange="this.form.submit()">
                                <span>{{ lang }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </details>
                </form>
            </aside>

            <section class="home-content">

                <div class="search-sort-container" style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 30px; width: 100%;">
                    
                    <div class="search-bar-container" style="flex-grow: 1; position: relative; max-width: 100%;">
                        <form action="/" method="GET" class="search-bar" id="search-form" style="display: flex; align-items: center; background: #fff; border: 1px solid #e5e5e5; border-radius: 50px; padding: 12px 20px; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.03);">
                            <input type="hidden" name="filter" value="{{ current_filter or '' }}">
                            <input type="hidden" name="lang" value="{{ current_lang or 'all' }}">
                            <input type="hidden" name="sort_price" value="{{ selected_sort_price or '' }}">
                            <span class="material-symbols-outlined" style="font-size: 22px; color: #888; flex-shrink: 0;">search</span>
                            <input type="text" name="query" id="search-input" placeholder="Cari Judul Buku atau Penulis" value="{{ search_query or '' }}" autocomplete="off" style="flex-grow: 1; border: none; outline: none; font-size: 1em; margin-left: 10px; background: transparent;">
                        </form>
                        
                        <div class="search-history" id="search-history-dropdown">
                            <div class="history-header">
                                <h3>Riwayat Pencarian</h3>
                                <button type="button" class="clear-history-btn" id="clear-history">Hapus Semua</button>
                            </div>
                            <ul class="history-list" id="history-list"></ul>
                        </div>
                    </div>
                
                    <div class="dropdown" id="urutkan" style="position: relative;">
                        <a href="#" class="nav-link dropdown-toggle" style="display: flex; align-items: center; gap: 10px; border: 1px solid #E0E0E0; border-radius: 12px; padding: 10px 20px; background-color: #FFFFFF; min-width: 180px; justify-content: space-between; text-decoration: none;">
                            <span class="filter-label" style="font-size: 0.9em; color: #6C757D;">Urutkan</span>
                            <span style="font-weight: 600; color: #1E1E1E; font-size: 0.95em;">
                                {% if selected_sort_price == 'asc' %}Harga Terendah
                                {% elif selected_sort_price == 'desc' %}Harga Tertinggi
                                {% else %}Harga Terendah
                                {% endif %}
                            </span>
                            <span class="arrow-down" style="border: solid #1E1E1E; border-width: 0 2px 2px 0; display: inline-block; padding: 3px; transform: rotate(45deg);"></span> 
                        </a>
                        <div class="dropdown-content">
                            <a href="/?sort_price=asc&query={{ search_query or '' }}&filter={{ current_filter or '' }}&lang={{ current_lang or 'all' }}">Harga Terendah</a>
                            <a href="/?sort_price=desc&query={{ search_query or '' }}&filter={{ current_filter or '' }}&lang={{ current_lang or 'all' }}">Harga Tertinggi</a>
                        </div>
                    </div>
                </div>

                {% if current_filter or search_query or current_lang != 'all' or selected_sort_price %}
                    
                    <div class="results-header-count">
                        Menampilkan <strong>{{ results_count }}</strong> dari <strong>{{ total_count }}</strong> produk
                        {% if search_query %} untuk "<strong>{{ search_query }}</strong>" {% endif %}
                    </div>
                    
                    {% if active_filters|length > 0 %}
                    <div class="active-filters-container">
                        <a href="/" class="filter-pill clear-all"><span>&times;</span></a>
                        {% for filter in active_filters %}
                            <div class="filter-pill">
                                <i class="fas fa-tag icon-tag"></i>
                                <span>{{ filter.value }}</span>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="results-grid" id="books-container">
                        {% for book in books %}
                            <div class="book-card-small">
                                <a href="/book/{{ book.id }}" class="card-link">
                                    <div class="card-image">
                                        {% if book.Gambar and book.Gambar != 'Tidak ditemukan' and book.Gambar|length > 5 %}
                                            <img src="{{ book.Gambar }}" 
                                                 alt="{{ book.Judul }}"
                                                 onerror=`this.onerror=null; this.src='{{ url_for("static", filename="img/placeholder.jpg") }}';`>
                                        {% else %}
                                            <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" 
                                                 alt="Gambar Tidak Tersedia">
                                        {% endif %}
                                    </div>
                                    <div class="card-content">
                                        <p class="author">{{ book['Penulis'] }}</p>
                                        <h5 class="title">{{ book['Judul'] }}</h5>
                                        {% if book['Harga'] %}
                                        <p class="price">{{ book['Harga'] }}</p>
                                        {% endif %}
                                    </div>
                                </a>
                            </div>
                        {% else %}
                            <div class="no-results">
                                <p>Maaf, buku tidak ditemukan.</p>
                            </div>
                        {% endfor %}
                    </div>

                    <div id="loading-indicator" style="text-align: center; padding: 20px; display: none; color: #666;">
                        <i class="fas fa-spinner fa-spin"></i> Memuat lebih banyak buku...
                    </div>
                    <div id="scroll-trigger" style="height: 20px; margin-bottom: 20px;"></div>

                {% else %}
                    {% for category, books in grouped_books.items() %}
                        {% if books %}
                        <div class="category-shelf">
                            <div class="shelf-header">
                                <h3>{{ category }}</h3>
                                <a href="/?filter=cat_{{ category | uquote }}" class="see-more">See More <span>&rarr;</span></a>
                            </div>
                            <div class="book-list-horizontal">
                                {% for book in books %}
                                <div class="book-card-small">
                                    <a href="/book/{{ book.id }}" class="card-link">
                                        <div class="card-image">
                                            {% if book.Gambar and book.Gambar != 'Tidak ditemukan' and book.Gambar|length > 5 %}
                                                <img src="{{ book.Gambar }}" alt="{{ book['Judul'] }}" onerror=`this.onerror=null; this.src='{{ url_for("static", filename="img/placeholder.jpg") }}';`>
                                            {% else %}
                                                <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" alt="Gambar Tidak Tersedia">
                                            {% endif %}
                                        </div>
                                        <div class="card-content">
                                            <p class="author">{{ book['Penulis'] }}</p>
                                            <h4 class="title">{{ book['Judul'] }}</h4>
                                            {% if book['Harga'] %}<p class="price">{{ book['Harga'] }}</p>{% endif %}
                                        </div>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

            </section>
        </div>
    </main>

   <footer class="footer">
        <div class="footer-bottom">
            Â© 2025 Bookora. All rights reserved.
        </div>
   </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. LOGIKA SEARCH HISTORY ---
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const historyDropdown = document.getElementById('search-history-dropdown');
    const historyList = document.getElementById('history-list');
    const clearHistoryBtn = document.getElementById('clear-history');

    let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];

    function renderHistory() {
        historyList.innerHTML = ''; 
        if (searchHistory.length === 0) {
            historyList.innerHTML = '<li class="history-empty">Belum ada riwayat pencarian</li>';
            clearHistoryBtn.style.display = 'none'; 
            return;
        }
        
        clearHistoryBtn.style.display = 'block'; 
        searchHistory.forEach((term, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <i class="fas fa-history"></i>
                <span class="history-term">${term}</span>
                <button type="button" class="delete-item-btn" data-index="${index}">&times;</button>
            `;
            historyList.appendChild(li);
        });
    }

    if(searchInput) {
        searchInput.addEventListener('focus', () => {
            renderHistory(); 
            historyDropdown.style.display = 'block';
        });
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-bar-container')) {
            if(historyDropdown) historyDropdown.style.display = 'none';
        }
    });

    if(searchForm) {
        searchForm.addEventListener('submit', (e) => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                if (searchHistory.includes(searchTerm)) {
                    searchHistory = searchHistory.filter(t => t !== searchTerm);
                }
                searchHistory.unshift(searchTerm);
                searchHistory = searchHistory.slice(0, 5); 
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            }
        });
    }

    if(clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', () => {
            searchHistory = [];
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderHistory();
        });
    }

    if(historyList) {
        historyList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-item-btn')) {
                e.stopPropagation(); 
                const index = e.target.getAttribute('data-index');
                searchHistory.splice(index, 1); 
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                renderHistory();
            }
            
            if (e.target.classList.contains('history-term')) {
                searchInput.value = e.target.textContent;
                searchForm.submit();
            }
        });
    }

    // --- 2. LOGIKA LAZY LOADING ---
    let offset = 20; 
    const limit = 20;
    let isLoading = false;
    let hasMore = true; 

    const container = document.getElementById('books-container');
    const loader = document.getElementById('loading-indicator');
    const trigger = document.getElementById('scroll-trigger');

    // Cek apakah elemen trigger ada (hanya ada di mode list/search, bukan di grouped shelf)
    if (trigger && container) {
        const urlParams = new URLSearchParams(window.location.search);
        
        async function loadMoreBooks() {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            if(loader) loader.style.display = 'block';

            urlParams.set('offset', offset);
            
            try {
                const response = await fetch(`/api/load-more?${urlParams.toString()}`);
                const newBooks = await response.json();

                if (newBooks.length === 0) {
                    hasMore = false;
                    if(loader) loader.innerHTML = "<p style='font-size:0.9em;'>Semua buku sudah ditampilkan.</p>";
                    return; 
                }

                newBooks.forEach(book => {
                    const card = document.createElement('div');
                    card.className = 'book-card-small';
                    
                    let imgSrc = book.Gambar;
                    let imgHtml = '';
                    
                    if (imgSrc && imgSrc !== 'Tidak ditemukan' && imgSrc.length > 5) {
                        // PENTING: Escape tanda kutip di sini
                        imgHtml = `<img src="${imgSrc}" alt="${book.Judul}" onerror="this.onerror=null; this.src='/static/img/placeholder.jpg';">`;
                    } else {
                        imgHtml = `<img src="/static/img/placeholder.jpg" alt="Gambar Tidak Tersedia">`;
                    }

                    card.innerHTML = `
                        <a href="/book/${book.id}" class="card-link">
                            <div class="card-image">
                                ${imgHtml}
                            </div>
                            <div class="card-content">
                                <p class="author">${book.Penulis || ''}</p>
                                <h5 class="title">${book.Judul}</h5>
                                ${book.Harga ? `<p class="price">${book.Harga}</p>` : ''}
                            </div>
                        </a>
                    `;
                    container.appendChild(card);
                });

                offset += limit; 

            } catch (error) {
                console.error('Gagal memuat buku:', error);
            } finally {
                isLoading = false;
                if(hasMore && loader) loader.style.display = 'none';
            }
        }

        const observer = new IntersectionObserver(entries => {
            if (entries[0].isIntersecting) {
                loadMoreBooks();
            }
        }, { rootMargin: '200px' }); 

        observer.observe(trigger);
    }
});
</script>

</body>
</html>