<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookara - Search Smarter, Read Better</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    
    <link rel="preconnect" href="https.googleapis.com">
    <link rel="preconnect" href="https.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=search" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* Animasi Sticky Navbar Search */
        #navbar-search-section {
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            flex: 1;
            display: flex;
            justify-content: center;
        }
        #navbar-search-section.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        #load-more-container {
            text-align: center;
            margin: 30px 0 50px 0;
        }
        .btn-load-more {
            background-color: transparent;
            border: 1px solid #A695FF;
            color: #A695FF;
            padding: 10px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }
        .btn-load-more:hover {
            background-color: #A695FF;
            color: #fff;
            box-shadow: 0 4px 10px rgba(166, 149, 255, 0.3);
        }
        .btn-load-more:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    
    <div id="global-loader">
        <div class="spinner-content">
            <i class="fas fa-circle-notch spinner-icon"></i>
            <div class="loading-text">Sedang Memuat...</div>
        </div>
    </div>

    <header class="navbar">
        <div class="container">
            <div class="navbar-left">
                <a href="/" class="navbar-brand">
                    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Bookara Logo">
                </a>
                <div class="dropdown">
                    <a href="/" class="nav-link">Kategori <span class="arrow"></span></a>
                    <div class="dropdown-content">
                        {% for cat in all_categories[:15] %}
                            <a href="/?filter=cat_{{ cat | uquote }}" onclick="showLoader()">{{ cat }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div id="navbar-search-section">
                <form action="/" method="GET" class="search-bar" id="navbar-search-form">
                    <span class="material-symbols-outlined" style="font-size: 20px;">search</span>
                    <input type="text" name="query" value="{{ search_query or '' }}" placeholder="Cari..." autocomplete="off">
                    <input type="hidden" name="lang" value="{{ current_lang or 'all' }}">
                    <input type="hidden" name="sort" value="{{ sort_option or 'price_asc' }}">
                </form>
                
                <button type="button" id="navbar-filter-btn" class="navbar-filter-btn" title="Filter & Urutkan">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>

            <nav class="navbar-right">
                <a href="/" class="nav-link active">Home</a>
                <a href="/about" class="nav-link">About Us</a>
                <a href="#contact" class="nav-link">Contact</a>
            </nav>
        </div>
    </header>

    <main>
        {% if not current_filter and not search_query and current_lang == 'all' and page_range == 'all' and (not sort_option or sort_option == 'price_asc') %}
        <section class="hero-carousel">
            <div class="carousel-slider">
                <div class="slide" id="slide-1"> 
                    <div class="slide-content">
                        <h1>Explore Great Books</h1>
                        <p>Temukan dunia baru di setiap halaman.</p>
                        <a href="#main-search-section" class="btn-primary" style="margin-top:15px; text-decoration:none;">Jelajahi Sekarang</a>
                    </div>
                </div>
                <div class="slide" id="slide-2">
                    <div class="slide-content">
                        <h1>Find Your Book Match</h1>
                        <p>Pilih bacaan yang paling sesuai dengan minat dan gaya Anda.</p>
                    </div>
                </div>
                <div class="slide" id="slide-3">
                    <div class="slide-content">
                        <h1>Browse by Category</h1>
                        <p>Pilih kategori favorit Anda untuk menemukan bacaan yang tepat.</p>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <div class="container page-layout">
            
            <aside class="home-sidebar">
                <h3 class="sidebar-title" style="padding: 20px 15px 10px; border-bottom: 2px solid #f0f0f0; margin-bottom: 10px;">Kategori</h3>
                
                <div class="sidebar-category">
                    <ul class="category-root">
                        {% for cat, sub1_map in nested_category_map.items() %}
                        <li>
                            <div class="cat-item">
                                <a href="/?filter=cat_{{ cat | uquote }}&lang={{ current_lang or 'all' }}&sort={{ sort_option or 'price_asc' }}" 
                                   class="{{ 'active' if current_filter == 'cat_' ~ cat else '' }}" onclick="showLoader()">
                                    {{ cat }}
                                </a>
                                {% if sub1_map %}
                                <span class="toggle-btn" onclick="toggleMenu(this)"><i class="fas fa-chevron-down"></i></span>
                                {% endif %}
                            </div>

                            {% if sub1_map %}
                            <ul class="submenu">
                                {% for sub1, sub2_map in sub1_map.items() %}
                                <li>
                                    <div class="cat-item">
                                        <a href="/?filter=sub_{{ cat | uquote }}|{{ sub1 | uquote }}&lang={{ current_lang or 'all' }}&sort={{ sort_option or 'price_asc' }}" 
                                           class="{{ 'active' if current_filter == 'sub_' ~ cat ~ '|' ~ sub1 else '' }}" onclick="showLoader()">
                                            {{ sub1 }}
                                        </a>
                                        {% if sub2_map %}
                                        <span class="toggle-btn" onclick="toggleMenu(this)"><i class="fas fa-chevron-down"></i></span>
                                        {% endif %}
                                    </div>

                                    {% if sub2_map %}
                                    <ul class="submenu">
                                        {% for sub2, sub3_list in sub2_map.items() %}
                                        <li>
                                            <div class="cat-item">
                                                <a href="/?filter=subsub_{{ cat | uquote }}|{{ sub1 | uquote }}|{{ sub2 | uquote }}&lang={{ current_lang or 'all' }}&sort={{ sort_option or 'price_asc' }}" 
                                                   class="{{ 'active' if current_filter == 'subsub_' ~ cat ~ '|' ~ sub1 ~ '|' ~ sub2 else '' }}" onclick="showLoader()">
                                                    {{ sub2 }}
                                                </a>
                                                {% if sub3_list %}
                                                <span class="toggle-btn" onclick="toggleMenu(this)"><i class="fas fa-chevron-down"></i></span>
                                                {% endif %}
                                            </div>

                                            {% if sub3_list %}
                                            <ul class="submenu">
                                                {% for sub3 in sub3_list %}
                                                <li>
                                                    <a href="/?filter=sub3_{{ cat | uquote }}|{{ sub1 | uquote }}|{{ sub2 | uquote }}|{{ sub3 | uquote }}&lang={{ current_lang or 'all' }}&sort={{ sort_option or 'price_asc' }}" 
                                                       class="leaf-link {{ 'active' if current_filter == 'sub3_' ~ cat ~ '|' ~ sub1 ~ '|' ~ sub2 ~ '|' ~ sub3 else '' }}" onclick="showLoader()">
                                                        - {{ sub3 }}
                                                    </a>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </aside>

            <section class="home-content">

                <div id="main-search-section">
                    <div class="search-sort-container" style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 30px; width: 100%;">
                        
                        <div class="search-bar-container" style="flex-grow: 1; position: relative; max-width: 100%;">
                            <form action="/" method="GET" class="search-bar" id="search-form" style="display: flex; align-items: center; background: #fff; border: 1px solid #e5e5e5; border-radius: 50px; padding: 12px 20px; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative;">
                                <input type="hidden" name="lang" value="{{ current_lang or 'all' }}" >
                                <input type="hidden" name="sort" value="{{ sort_option or 'price_asc' }}" >
                                
                                <span class="material-symbols-outlined" style="font-size: 22px; color: #888; flex-shrink: 0;">search</span>
                                <input type="text" name="query" id="search-input" placeholder="Cari Judul Buku atau Penulis" value="{{ search_query or '' }}"  autocomplete="off" style="flex-grow: 1; border: none; outline: none; font-size: 1em; margin-left: 10px; background: transparent; padding-right: 30px;">
                                
                                <button type="button" id="clear-search-btn" style="display: none; background: none; border: none; color: #999; cursor: pointer; font-size: 18px; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); padding: 5px;">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </form>
                            
                       <div class="search-history" id="search-history-dropdown">
                            <div class="history-header">
                                <h3>Riwayat Pencarian</h3>
                                <button type="button" class="clear-history-btn" id="clear-history">Hapus Semua</button>
                            </div>
                            <ul class="history-list" id="history-list"></ul>
                        </div>
                    </div>

                        <button type="button" id="open-filter-btn" class="btn-filter-trigger">
                            <i class="fas fa-sliders-h"></i> Filter & Urutkan
                        </button>

                    </div>
                </div>

                {% if current_filter or search_query or current_lang != 'all' or (sort_option and sort_option != 'price_asc') or page_range != 'all' %}
                    
                    <div class="results-header-count" style="margin-bottom: 10px;">
                        Menampilkan <strong>{{ results_count }}</strong> dari <strong>{{ total_count }}</strong> produk
                        {% if search_query %} untuk "<strong>{{ search_query }}</strong>" {% endif %}
                    </div>
                    
                    {% if active_filters|length > 0 %}
                    <div class="active-filters-container">
                        <button onclick="clearAllFilters()" class="filter-pill clear-all-btn" title="Hapus Semua Filter">
                            <i class="fas fa-times"></i>
                        </button>
                        {% for filter in active_filters %}
                            {% if filter.key == 'sort' %}
                                <div class="filter-pill" style="cursor:default; background-color:#f0f0f0;">
                                    <i class="fas fa-sort icon-tag"></i>
                                    <span>{{ filter.value }}</span>
                                </div>
                            {% else %}
                                <div class="filter-pill" onclick="removeParam('{{ filter.key }}')">
                                    <i class="fas fa-tag icon-tag"></i>
                                    <span>{{ filter.value }}</span>
                                    <span class="remove-single"><i class="fas fa-times"></i></span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="results-grid" id="books-container">
                        {% for book in books %}
                            <div class="book-card-small">
                                <a href="/book/{{ book.id }}" class="card-link"  >
                                    <div class="card-image">
                                        {% if book.Gambar and book.Gambar != 'Tidak ditemukan' and book.Gambar|length > 5 %}
                                            <img src="{{ book.Gambar }}" alt="{{ book.Judul }}" onerror="this.onerror=null; this.src='/static/img/placeholder.jpg';">
                                        {% else %}
                                            <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" alt="Gambar Tidak Tersedia">
                                        {% endif %}
                                    </div>
                                    <div class="card-content">
                                        <p class="author">{{ book['Penulis'] }}</p>
                                        <h5 class="title">{{ book['Judul'] }}</h5>
                                        {% if book['Harga'] %}
                                        <p class="price" style="font-weight:700; font-size:0.9em; color:#A695FF;">{{ book['Harga'] }}</p>
                                        {% endif %}
                                    </div>
                                </a>
                            </div>
                        {% else %}
                            <div class="no-results">
                                <p>Maaf, buku tidak ditemukan.</p>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if total_count > books|length %}
                    <div id="load-more-container">
                        <button id="load-more-btn" class="btn-load-more" data-offset="20" data-total="{{ total_count }}">
                            Muat Lebih Banyak
                        </button>
                        <p id="no-more-text" style="display: none; color: #888; margin-top: 10px; font-size: 0.9em;">
                            Semua buku sudah ditampilkan.
                        </p>
                    </div>
                    {% endif %}

                {% else %}
                    {% for category, books in grouped_books.items() %}
                        {% if books %}
                        <div class="category-shelf">
                            <div class="shelf-header">
                                <h3>{{ category }}</h3>
                                <a href="/?filter=cat_{{ category | uquote }}" class="see-more" onclick="showLoader()">See More <span>&rarr;</span></a>
                            </div>
                            <div class="book-list-horizontal">
                                {% for book in books %}
                                <div class="book-card-small">
                                    <a href="/book/{{ book.id }}" class="card-link">
                                        <div class="card-image">
                                            {% if book.Gambar and book.Gambar != 'Tidak ditemukan' and book.Gambar|length > 5 %}
                                                <img src="{{ book.Gambar }}" alt="{{ book['Judul'] }}" onerror="this.onerror=null; this.src='/static/img/placeholder.jpg';">
                                            {% else %}
                                                <img src="{{ url_for('static', filename='img/placeholder.jpg') }}" alt="Gambar Tidak Tersedia">
                                            {% endif %}
                                        </div>
                                        <div class="card-content">
                                            <p class="author">{{ book['Penulis'] }}</p>
                                            <h4 class="title">{{ book['Judul'] }}</h4>
                                            {% if book['Harga'] %}<p class="price" style="font-weight:700; font-size:0.9em; color:#A695FF;">{{ book['Harga'] }}</p>{% endif %}
                                        </div>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

            </section>
        </div>
    </main>

    <footer class="footer" id="contact">
        <div class="footer-top">
            <div class="footer-logo">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Bookara" />
            </div>
            <div class="footer-tagline">Search Smarter. Read Better.</div>
        </div>

        <div class="footer-container">
            <div class="footer-column">
                <h3>Company</h3>
                <a href="#">Home</a>
                <a href="#">About Us</a>
                <a href="#">Kategori</a>
                <a href="#">Contact</a>
            </div>
            <div class="footer-column">
                <h3>Support</h3>
                <a href="#">Help Center</a>
                <a href="#">How It Works</a>
                <a href="#">Report an Issue</a>
            </div>
            <div class="footer-column">
                <h3>Legal</h3>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
            <div class="footer-column">
                <h3>Connect</h3>
                <p style="margin-bottom:10px; font-weight:600">Social Media:</p>
                <div class="social-icons">
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-x-twitter"></i>
                    <i class="fab fa-facebook"></i>
                    <i class="fab fa-linkedin"></i>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            Â© 2025 Bookora. All rights reserved.
        </div>
    </footer>

    <div id="filter-modal" class="filter-modal">
        <div class="filter-modal-content">
            <form action="/" method="GET" id="modal-filter-form">
                <div class="filter-modal-header">
                    <h3>Filter & Urutkan</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <input type="hidden" name="query" value="{{ search_query or '' }}">
                <input type="hidden" name="filter" value="{{ current_filter or '' }}">

                <div class="filter-modal-body">
                    <div class="filter-group-modal">
                        <h4>Urutkan</h4>
                        <div class="radio-list">
                            <label class="modal-radio full-width">
                                <input type="radio" name="sort" value="price_asc" {% if not sort_option or sort_option == 'price_asc' %}checked{% endif %}>
                                <span>Harga Terendah</span>
                            </label>
                            <label class="modal-radio full-width">
                                <input type="radio" name="sort" value="price_desc" {% if sort_option == 'price_desc' %}checked{% endif %}>
                                <span>Harga Tertinggi</span>
                            </label>
                            <label class="modal-radio full-width">
                                <input type="radio" name="sort" value="date_newest" {% if sort_option == 'date_newest' %}checked{% endif %}>
                                <span>Terbaru (Tahun Terbit)</span>
                            </label>
                            <label class="modal-radio full-width">
                                <input type="radio" name="sort" value="date_oldest" {% if sort_option == 'date_oldest' %}checked{% endif %}>
                                <span>Terlama (Tahun Terbit)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-group-modal">
                        <h4>Bahasa</h4>
                        <div class="radio-grid">
                            <label class="modal-radio">
                                <input type="radio" name="lang" value="all" {% if current_lang == 'all' %}checked{% endif %}>
                                <span>Semua</span>
                            </label>
                            {% for lang in all_languages %}
                            <label class="modal-radio">
                                <input type="radio" name="lang" value="{{ lang }}" {% if current_lang == lang %}checked{% endif %}>
                                <span>
                                    {% if lang == 'English' %}
                                        Inggris
                                    {% elif lang == '-' %}
                                        Lainnya
                                    {% else %}
                                        {{ lang }}
                                    {% endif %}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="filter-group-modal">
                        <h4>Jumlah Halaman</h4>
                        <div class="radio-list">
                            <label class="modal-radio full-width">
                                <input type="radio" name="page_range" value="all" {% if page_range == 'all' %}checked{% endif %}>
                                <span>Semua Halaman</span>
                            </label>
                            <label class="modal-radio full-width">
                                <input type="radio" name="page_range" value="0-100" {% if page_range == '0-100' %}checked{% endif %}>
                                <span>< 100 Halaman</span>
                            </label>
                            <label class="modal-radio full-width">
                                <input type="radio" name="page_range" value="100-200" {% if page_range == '100-200' %}checked{% endif %}>
                                <span>100 - 200 Halaman</span>
                            </label>
                            <label class="modal-radio full-width">
                                <input type="radio" name="page_range" value="200+" {% if page_range == '200+' %}checked{% endif %}>
                                <span>> 200 Halaman</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="filter-modal-footer">
                    <button type="button" class="btn-reset" onclick="resetModalFilters()">Reset</button>
                    <button type="submit" class="btn-apply" onclick="showLoader()">Terapkan Filter</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function toggleMenu(element) {
            const parentDiv = element.closest('.cat-item');
            const parentLi = parentDiv.parentElement; 
            const submenu = parentLi.querySelector(':scope > .submenu');
            if (submenu) {
                if (submenu.style.display === "block") {
                    submenu.style.display = "none";
                    element.classList.remove("rotate");
                } else {
                    submenu.style.display = "block";
                    element.classList.add("rotate");
                }
            }
        }
        document.addEventListener("DOMContentLoaded", function() {
            const activeLink = document.querySelector('.sidebar-category .active');
            if (activeLink) {
                let parent = activeLink.parentElement;
                while (parent) {
                    if (parent.classList.contains('submenu')) {
                        parent.style.display = 'block';
                        const parentLi = parent.parentElement;
                        const toggleBtn = parentLi.querySelector('.cat-item > .toggle-btn');
                        if (toggleBtn) toggleBtn.classList.add('rotate');
                    }
                    if (parent.classList.contains('category-root')) break;
                    parent = parent.parentElement;
                }
            }
        });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById("filter-modal");
        const btnMain = document.getElementById("open-filter-btn");
        const btnNav = document.getElementById("navbar-filter-btn");
        const span = document.getElementsByClassName("close-modal")[0];

        function openModal() { modal.style.display = "flex"; }

        if (btnMain) btnMain.onclick = openModal;
        if (btnNav) btnNav.onclick = openModal;
        if (span) span.onclick = function() { modal.style.display = "none"; };

        window.onclick = function(event) { if (event.target == modal) modal.style.display = "none"; }
    });

    function resetModalFilters() {
        const form = document.getElementById('modal-filter-form');
        form.querySelectorAll('input[name="sort"]').forEach(r => r.checked = (r.value === "price_asc"));
        form.querySelectorAll('input[name="lang"]').forEach(r => r.checked = (r.value === "all"));
        form.querySelectorAll('input[name="page_range"]').forEach(r => r.checked = (r.value === "all"));
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // SEARCH HISTORY
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const historyDropdown = document.getElementById('search-history-dropdown');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history');
        const clearSearchBtn = document.getElementById('clear-search-btn');

        let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];

        function renderHistory() {
            if(!historyList) return;
            historyList.innerHTML = ''; 
            if (searchHistory.length === 0) {
                historyList.innerHTML = '<li class="history-empty">Belum ada riwayat pencarian</li>';
                if(clearHistoryBtn) clearHistoryBtn.style.display = 'none'; 
                return;
            }
            if(clearHistoryBtn) clearHistoryBtn.style.display = 'block'; 
            searchHistory.forEach((term, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-history"></i><span class="history-term">${term}</span><button type="button" class="delete-item-btn" data-index="${index}">&times;</button>`;
                historyList.appendChild(li);
            });
        }

        if(searchInput) {
            searchInput.addEventListener('focus', () => { renderHistory(); if(historyDropdown) historyDropdown.style.display = 'block'; });
            searchInput.addEventListener('input', function() { if(clearSearchBtn) clearSearchBtn.style.display = this.value.trim().length > 0 ? 'block' : 'none'; });
            if(clearSearchBtn) clearSearchBtn.style.display = searchInput.value.trim().length > 0 ? 'block' : 'none';
        }

        if(clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function(e) { e.preventDefault(); searchInput.value = ''; this.style.display = 'none'; searchInput.focus(); });
        }

        document.addEventListener('click', (e) => { if (!e.target.closest('.search-bar-container')) { if(historyDropdown) historyDropdown.style.display = 'none'; } });

        if(searchForm) {
            searchForm.addEventListener('submit', (e) => {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    if (searchHistory.includes(searchTerm)) searchHistory = searchHistory.filter(t => t !== searchTerm);
                    searchHistory.unshift(searchTerm);
                    searchHistory = searchHistory.slice(0, 5); 
                    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                }
            });
        }
        if(clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', () => { searchHistory = []; localStorage.setItem('searchHistory', JSON.stringify(searchHistory)); renderHistory(); });
        }
        if(historyList) {
            historyList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-item-btn')) { e.stopPropagation(); const index = e.target.getAttribute('data-index'); searchHistory.splice(index, 1); localStorage.setItem('searchHistory', JSON.stringify(searchHistory)); renderHistory(); }
                if (e.target.classList.contains('history-term')) { searchInput.value = e.target.textContent; searchForm.submit(); }
            });
        }

        // ==========================================
        // SMART LOAD MORE LOGIC (JavaScript Side)
        // ==========================================
        const loadMoreBtn = document.getElementById('load-more-btn');
        const noMoreText = document.getElementById('no-more-text');
        const container = document.getElementById('books-container');

        if (loadMoreBtn && container) {
            loadMoreBtn.addEventListener('click', function() {
                // 1. Ambil data dari atribut tombol
                let currentOffset = parseInt(this.getAttribute('data-offset'));
                let totalBooks = parseInt(this.getAttribute('data-total'));
                
                // 2. Ambil filter dari URL
                const params = new URLSearchParams(window.location.search);
                
                // 3. UI Loading state
                const originalText = this.innerText;
                this.innerText = 'Memuat...';
                this.disabled = true;

                // 4. Update offset di params fetch
                params.set('offset', currentOffset);

                // 5. Fetch Data
                fetch(`/api/load-more?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            // Render buku
                            data.forEach(book => {
                                const card = document.createElement('div'); 
                                card.className = 'book-card-small';
                                let imgHtml = (book.Gambar && book.Gambar !== 'Tidak ditemukan' && book.Gambar.length > 5) 
                                    ? `<img src="${book.Gambar}" alt="${book.Judul}" onerror="this.onerror=null; this.src='/static/img/placeholder.jpg';">` 
                                    : `<img src="/static/img/placeholder.jpg" alt="Gambar Tidak Tersedia">`;
                                
                                card.innerHTML = `
                                    <a href="/book/${book.id}" class="card-link">
                                        <div class="card-image">${imgHtml}</div>
                                        <div class="card-content">
                                            <p class="author">${book.Penulis || ''}</p>
                                            <h5 class="title">${book.Judul}</h5>
                                            ${book.Harga ? `<p class="price" style="font-weight:700; font-size:0.9em; color:#A695FF;">${book.Harga}</p>` : ''}
                                        </div>
                                    </a>`;
                                container.appendChild(card);
                            });

                            // 6. Hitung Offset Baru
                            const newOffset = currentOffset + 20;
                            loadMoreBtn.setAttribute('data-offset', newOffset);

                            // 7. Cek apakah sudah habis?
                            // Jika offset baru melebihi total, ATAU data yg dikembalikan kurang dari limit
                            if (newOffset >= totalBooks || data.length < 20) {
                                loadMoreBtn.style.display = 'none';
                                if (noMoreText) noMoreText.style.display = 'block';
                            } else {
                                loadMoreBtn.innerText = originalText;
                                loadMoreBtn.disabled = false;
                            }
                        } else {
                            // Data kosong (Safety net)
                            loadMoreBtn.style.display = 'none';
                            if (noMoreText) noMoreText.style.display = 'block';
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        loadMoreBtn.innerText = 'Gagal. Coba lagi.';
                        loadMoreBtn.disabled = false;
                    });
            });
        }

        // STICKY NAVBAR LOGIC
        const mainSearch = document.getElementById('main-search-section');
        const navSearch = document.getElementById('navbar-search-section');
        if (mainSearch && navSearch) {
            const navObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) navSearch.classList.remove('visible'); else navSearch.classList.add('visible'); });
            }, { threshold: 0.1 });
            navObserver.observe(mainSearch);
        }
    });
    </script>

    <script>
        function showLoader() { const loader = document.getElementById('global-loader'); if (loader) loader.style.display = 'flex'; }
        window.addEventListener("pageshow", function(event) { const loader = document.getElementById('global-loader'); if (event.persisted && loader) loader.style.display = "none"; });
        function removeParam(key) { const url = new URL(window.location.href); url.searchParams.delete(key); if (url.searchParams.has('offset')) url.searchParams.delete('offset'); showLoader(); window.location.href = url.toString(); }
        function clearAllFilters() { showLoader(); window.location.href = '/'; }
    </script>
</body>
</html>